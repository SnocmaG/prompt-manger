// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["views"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Prompt {
  id            String   @id @default(uuid())
  clientId      String   // Workspace/tenant identifier
  name          String   // e.g., "support_email_prompt"
  liveVersionId String?  // Current live version
  defaultModel  String?  // e.g. "gpt-4o", "gpt-4o-mini"
  
  createdAt     DateTime @default(now())
  createdBy     String
  updatedAt     DateTime @updatedAt
  updatedBy     String

  versions      PromptVersion[]
  executions    PromptExecution[]
  environments  PromptEnvironment[]
  
  @@unique([clientId, name])
  @@index([clientId])
}

model PromptEnvironment {
  id        String   @id @default(uuid())
  promptId  String
  prompt    Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  
  slug      String   // "production", "staging"
  color     String?  // UI color helper e.g. "red", "green"
  
  versionId String
  version   PromptVersion @relation(fields: [versionId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([promptId, slug])
}

model PromptVersion {
  id              String   @id @default(uuid())
  promptId        String
  systemPrompt    String   @db.Text
  userPrompt      String   @db.Text
  label           String   // e.g., "v3 â€“ shorter intro"
  
  createdAt       DateTime @default(now())
  createdBy       String
  updatedAt       DateTime @updatedAt
  updatedBy       String
  
  prompt          Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  deployments     PromptEnvironment[]
  evaluationRuns  EvaluationRun[]
  
  @@index([promptId])
  @@index([createdAt])
}

model PromptExecution {
  id            String   @id @default(uuid())
  promptId      String
  prompt        Prompt   @relation(fields: [promptId], references: [id], onDelete: Cascade)
  
  versionLabel  String?  // verification reference e.g. "v2.0" or "Unsaved"
  systemPrompt  String   @db.Text
  userPrompt    String   @db.Text
  
  model         String
  provider      String   // openai, anthropic, etc.
  response      String   @db.Text
  
  createdAt     DateTime @default(now())
  createdBy     String
  
  // Observability
  durationMs    Int?
  tokensIn      Int?
  tokensOut     Int?
  cost          Float?
  
  @@index([createdAt])
}

model ApiKey {
  id        String   @id @default(uuid())
  key       String   @unique
  name      String
  clientId  String   // Workspace/tenant identifier (User ID or Org ID)
  
  createdAt DateTime @default(now())
  lastUsed  DateTime?
  
  createdBy String   // User who created the key
  isAdmin   Boolean  @default(false)
  
  @@index([clientId])
}

// --- Evaluations & Testing ---

model Evaluation {
  id        String   @id @default(uuid())
  clientId  String
  name      String   // e.g. "Support Golden Dataset"
  
  items     EvaluationItem[]
  runs      EvaluationRun[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([clientId])
}

model EvaluationItem {
  id            String     @id @default(uuid())
  evaluationId  String
  evaluation    Evaluation @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  
  // JSON string of variables: { "customer": "John", "topic": "Refund" }
  input         String     @db.Text 
  expectedOutput String?   @db.Text
  
  createdAt     DateTime   @default(now())
  
  results       EvaluationResult[]
}

model EvaluationRun {
  id              String         @id @default(uuid())
  evaluationId    String
  evaluation      Evaluation     @relation(fields: [evaluationId], references: [id])
  
  promptVersionId String
  promptVersion   PromptVersion  @relation(fields: [promptVersionId], references: [id])
  
  results         EvaluationResult[]
  
  score           Float?         // 0-100%
  status          String         @default("running") // running, completed, error
  
  createdAt       DateTime       @default(now())
}

model EvaluationResult {
  id               String         @id @default(uuid())
  evaluationRunId  String
  evaluationRun    EvaluationRun  @relation(fields: [evaluationRunId], references: [id], onDelete: Cascade)
  
  evaluationItemId String
  evaluationItem   EvaluationItem @relation(fields: [evaluationItemId], references: [id])
  
  output           String         @db.Text
  passed           Boolean?
  score            Float?         // 0-1 if graded by LLM
  
  createdAt        DateTime       @default(now())
}

model Review {
  id              String   @id @default(uuid())
  reviewId        String   @unique
  
  starRating      Int?
  reviewText      String   @db.Text
  reviewDate      DateTime?

  // Mapped field
  reviewType      String?  @map("Review Type")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
